name: Test Matrix

on: [push, pull_request]

jobs:
  test-distros:
    # å…³é”®ç‚¹ 1: åœ¨ Ubuntu å®¿ä¸»æœºä¸Šè¿è¡Œ Jobï¼Œè€Œä¸æ˜¯ç›´æ¥åœ¨å®¹å™¨é‡Œè·‘
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        container:
          - 'debian:11'
          - 'debian:12'
          - 'ubuntu:22.04'
          - 'alpine:latest'
          - 'almalinux:9'
          - 'rockylinux:9'
          - 'centos:7'                        # è¿™é‡Œçš„ CentOS 7 ç°åœ¨å¯ä»¥è·‘äº†ï¼
          - 'quay.io/centos/centos:stream9'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Test in Container
        run: |
          echo "ğŸš€ Testing on image: ${{ matrix.container }}"
          chmod +x init.sh

          # å¯åŠ¨å®¹å™¨
          docker run --rm --privileged -v $(pwd):/mnt -w /mnt ${{ matrix.container }} /bin/sh -c '
            
            # è°ƒè¯•ä¿¡æ¯ï¼šæ‰“å°å½“å‰ç³»ç»Ÿç‰ˆæœ¬
            if [ -f /etc/redhat-release ]; then
                echo "ğŸ“ System detected: $(cat /etc/redhat-release)"
            fi

            # ============================================
            # 1. é’ˆå¯¹ CentOS 7 çš„â€œèµ·æ­»å›ç”Ÿâ€è¡¥ä¸ (æ­£åˆ™ä¿®æ­£ç‰ˆ)
            # ============================================
            # [FIX] æ”¹ä¸ºåŒ¹é… "release 7"ï¼Œå…¼å®¹ "CentOS Linux release 7.x.x"
            if [ -f /etc/redhat-release ] && grep -q "release 7" /etc/redhat-release; then
              echo "ğŸ’€ Detected CentOS 7 (EOL). Fixing repositories to Vault..."
              
              # æš´åŠ›æ›¿æ¢æ‰€æœ‰ repo æ–‡ä»¶ (base, updates, extras ç­‰)
              # 1. æ³¨é‡Šæ‰å¤±æ•ˆçš„ mirrorlist
              sed -i "s/^mirrorlist/#mirrorlist/g" /etc/yum.repos.d/*.repo
              
              # 2. å¯ç”¨ baseurl å¹¶æŒ‡å‘ vault
              sed -i "s|^#baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g" /etc/yum.repos.d/*.repo
              sed -i "s|^baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g" /etc/yum.repos.d/*.repo
              
              # 3. å¼ºåˆ¶æ¸…ç†ç¼“å­˜
              yum clean all
              rm -rf /var/cache/yum
            fi

            # ============================================
            # 2. ç¯å¢ƒè¡¥å…¨
            # ============================================
            echo "ğŸ“¦ Installing dependencies..."
            
            # --- Debian / Ubuntu ---
            if [ -f /etc/debian_version ]; then
              apt-get update -y && apt-get install -y curl sudo openssh-server
              ssh-keygen -A
              mkdir -p /run/sshd
            fi

            # --- Alpine ---
            if [ -f /etc/alpine-release ]; then
              apk add --no-cache curl sudo openssh-server bash
              ssh-keygen -A
            fi

            # --- RHEL / CentOS / Alma / Rocky ---
            if [ -f /etc/redhat-release ]; then
              # AlmaLinux 9 è§£å†³ curl-minimal å†²çª
              if command -v dnf >/dev/null; then
                dnf install -y --allowerasing curl sudo openssh-server
              else
                # CentOS 7 ä¼šèµ°è¿™é‡Œï¼Œç°åœ¨æºä¿®å¥½äº†ï¼Œå®‰è£…åº”è¯¥æ²¡é—®é¢˜
                yum install -y curl sudo openssh-server
              fi
              
              ssh-keygen -A
              mkdir -p /run/sshd
            fi

            # ============================================
            # 3. è¿è¡Œè„šæœ¬
            # ============================================
            echo "ğŸš€ Running init script..."
            ./init.sh --user=root --port=2222 --key-raw="ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIPQQDejyTCPJO3Jyw5UX9jmojb/zjgcqVuRO28fmpWU5" --no-update --bbr --delay-restart --yes --strict
            
            # ============================================
            # 4. éªŒè¯ç»“æœ
            # ============================================
            if grep -q "BEGIN SERVER-INIT MANAGED BLOCK" /etc/ssh/sshd_config; then
               echo "âœ… SUCCESS: Config block injected."
            else
               echo "âŒ FAIL: Config block missing."
               exit 1
            fi
          '
